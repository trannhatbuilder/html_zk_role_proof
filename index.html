<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZKP Authentication System - RBAC Login</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="zkp-animation inline-block">
                <i class="fas fa-shield-alt text-white text-5xl mb-4"></i>
            </div>
            <h1 class="text-3xl font-bold text-white mb-2">ZKP Authentication</h1>
            <p class="text-gray-200">Zero-Knowledge Proof với RBAC</p>
        </div>

        <!-- Login Form -->
        <div class="glass-effect rounded-2xl p-8 shadow-2xl">
            <form id="loginForm" class="space-y-6">
                <!-- Email Input -->
                <div>
                    <label for="email" class="block text-sm font-medium text-white mb-2">
                        <i class="fas fa-envelope mr-2"></i>Email
                    </label>
                    <input type="email" id="email" name="email" required
                           class="w-full px-4 py-3 bg-white bg-opacity-20 border border-white border-opacity-30 rounded-lg text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent"
                           placeholder="Nhập email của bạn">
                </div>

                <!-- Password Input -->
                <div>
                    <label for="password" class="block text-sm font-medium text-white mb-2">
                        <i class="fas fa-lock mr-2"></i>Mật khẩu
                    </label>
                    <div class="relative">
                        <input type="password" id="password" name="password" required
                               class="w-full px-4 py-3 bg-white bg-opacity-20 border border-white border-opacity-30 rounded-lg text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent pr-12"
                               placeholder="Nhập mật khẩu">
                        <button type="button" id="togglePassword" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-300 hover:text-white">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <!-- Role Selection -->
                <div>
                    <label class="block text-sm font-medium text-white mb-3">
                        <i class="fas fa-users mr-2"></i>Chọn vai trò
                    </label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="role-option cursor-pointer">
                            <input type="radio" name="role" value="IT" class="sr-only">
                            <div class="p-3 bg-white bg-opacity-20 border-2 border-white border-opacity-30 rounded-lg text-center text-white hover:bg-opacity-30 transition-all duration-200">
                                <i class="fas fa-laptop-code text-xl mb-1"></i>
                                <div class="text-sm font-medium">IT</div>
                            </div>
                        </label>
                        <label class="role-option cursor-pointer">
                            <input type="radio" name="role" value="HR" class="sr-only">
                            <div class="p-3 bg-white bg-opacity-20 border-2 border-white border-opacity-30 rounded-lg text-center text-white hover:bg-opacity-30 transition-all duration-200">
                                <i class="fas fa-user-tie text-xl mb-1"></i>
                                <div class="text-sm font-medium">HR</div>
                            </div>
                        </label>
                        <label class="role-option cursor-pointer">
                            <input type="radio" name="role" value="Finance" class="sr-only">
                            <div class="p-3 bg-white bg-opacity-20 border-2 border-white border-opacity-30 rounded-lg text-center text-white hover:bg-opacity-30 transition-all duration-200">
                                <i class="fas fa-calculator text-xl mb-1"></i>
                                <div class="text-sm font-medium">Finance</div>
                            </div>
                        </label>
                        <label class="role-option cursor-pointer">
                            <input type="radio" name="role" value="Admin" class="sr-only">
                            <div class="p-3 bg-white bg-opacity-20 border-2 border-white border-opacity-30 rounded-lg text-center text-white hover:bg-opacity-30 transition-all duration-200">
                                <i class="fas fa-crown text-xl mb-1"></i>
                                <div class="text-sm font-medium">Admin</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- ZKP Status -->
                <div id="zkpStatus" class="hidden">
                    <div class="bg-blue-500 bg-opacity-30 border border-blue-400 rounded-lg p-3">
                        <div class="flex items-center text-white">
                            <div class="loading-spinner mr-3"></div>
                            <div>
                                <div class="font-medium">Đang tạo ZK Proof...</div>
                                <div class="text-sm opacity-75" id="zkpStep">Khởi tạo Circom circuit</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" id="submitBtn"
                        class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:from-blue-600 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 focus:ring-offset-transparent transition-all duration-200 transform hover:scale-105">
                    <i class="fas fa-sign-in-alt mr-2"></i>
                    Đăng nhập với ZKP
                </button>
            </form>
        </div>

        <!-- Footer -->
        <div class="text-center mt-6 text-white text-sm opacity-75">
            <p>&copy; <a href="https://github.com/trannhatbuilder" target="_blank" rel="noopener noreferrer">trannhatbuilder</a></p>
        </div>
    </div>

    <script>
        // ZKP Authentication System with RBAC
        class ZKPAuthenticator {
            constructor() {
                this.init();
                this.setupEventListeners();
            }

            init() {
                console.log('ZKP Authenticator initialized');
                // Initialize Circom environment (placeholder)
                this.initCircom();
            }

            async initCircom() {
                // Placeholder for Circom initialization
                console.log('Initializing Circom environment...');
                // In real implementation, you would load:
                // - Circuit WASM file
                // - Proving key
                // - Verification key
            }

            setupEventListeners() {
                // Toggle password visibility
                document.getElementById('togglePassword').addEventListener('click', this.togglePasswordVisibility);

                // Role selection
                document.querySelectorAll('input[name="role"]').forEach(radio => {
                    radio.addEventListener('change', this.handleRoleSelection);
                });

                // Form submission
                document.getElementById('loginForm').addEventListener('submit', this.handleSubmit.bind(this));
            }

            togglePasswordVisibility() {
                const passwordInput = document.getElementById('password');
                const toggleIcon = document.querySelector('#togglePassword i');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    toggleIcon.classList.remove('fa-eye');
                    toggleIcon.classList.add('fa-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    toggleIcon.classList.remove('fa-eye-slash');
                    toggleIcon.classList.add('fa-eye');
                }
            }

            handleRoleSelection(event) {
                // Update visual selection
                document.querySelectorAll('.role-option div').forEach(div => {
                    div.classList.remove('bg-blue-500', 'bg-opacity-50', 'border-blue-400');
                    div.classList.add('bg-white', 'bg-opacity-20', 'border-white', 'border-opacity-30');
                });

                const selectedDiv = event.target.closest('.role-option').querySelector('div');
                selectedDiv.classList.remove('bg-white', 'bg-opacity-20', 'border-white', 'border-opacity-30');
                selectedDiv.classList.add('bg-blue-500', 'bg-opacity-50', 'border-blue-400');
            }

            async handleSubmit(event) {
                event.preventDefault();
                
                const formData = new FormData(event.target);
                const email = formData.get('email');
                const password = formData.get('password');
                const role = formData.get('role');

                if (!role) {
                    this.showError('Vui lòng chọn vai trò');
                    return;
                }

                try {
                    await this.authenticateWithZKP(email, password, role);
                } catch (error) {
                    this.showError('Xác thực thất bại: ' + error.message);
                }
            }

            async authenticateWithZKP(email, password, role) {
                // Show ZKP status
                document.getElementById('zkpStatus').classList.remove('hidden');
                document.getElementById('submitBtn').disabled = true;

                try {
                    // Step 1: Generate witness
                    await this.updateZKPStep('Tạo witness từ thông tin đăng nhập...');
                    await this.delay(1000);
                    const witness = await this.generateWitness(email, password, role);

                    // Step 2: Generate proof
                    await this.updateZKPStep('Tạo Zero-Knowledge Proof...');
                    await this.delay(1500);
                    const proof = await this.generateProof(witness);

                    // Step 3: Verify proof
                    await this.updateZKPStep('Xác minh proof...');
                    await this.delay(1000);
                    const isValid = await this.verifyProof(proof, role);

                    if (isValid) {
                        await this.updateZKPStep('Xác thực thành công!');
                        await this.delay(500);
                        this.redirectToRoleBasedPage(role);
                    } else {
                        throw new Error('Proof verification failed');
                    }

                } catch (error) {
                    document.getElementById('zkpStatus').classList.add('hidden');
                    document.getElementById('submitBtn').disabled = false;
                    throw error;
                }
            }

            async generateWitness(email, password, role) {
                // Placeholder for witness generation
                // In real implementation, this would:
                // 1. Hash the credentials
                // 2. Create circuit inputs
                // 3. Generate witness using Circom
                
                console.log('Generating witness for:', { email, role });
                
                return {
                    email_hash: this.hashString(email),
                    password_hash: this.hashString(password),
                    role_id: this.getRoleId(role),
                    timestamp: Date.now()
                };
            }

            async generateProof(witness) {
                // Placeholder for proof generation
                // In real implementation, this would use snarkjs:
                // const { proof, publicSignals } = await snarkjs.groth16.fullProve(witness, wasmPath, zkeyPath);
                
                console.log('Generating ZK proof for witness:', witness);
                
                return {
                    pi_a: ['0x1234...', '0x5678...', '0x1'],
                    pi_b: [['0xabcd...', '0xefgh...'], ['0xijkl...', '0xmnop...'], ['0x1', '0x0']],
                    pi_c: ['0xqrst...', '0xuvwx...', '0x1'],
                    publicSignals: [witness.role_id, witness.timestamp]
                };
            }

            async verifyProof(proof, role) {
                // Placeholder for proof verification
                // In real implementation, this would use snarkjs:
                // const res = await snarkjs.groth16.verify(vKey, proof.publicSignals, proof);
                
                console.log('Verifying proof for role:', role);
                
                // Mock verification logic
                const validRoles = ['IT', 'HR', 'Finance', 'Admin'];
                return validRoles.includes(role);
            }

            redirectToRoleBasedPage(role) {
                // Role-based redirection
                const rolePages = {
                    'IT': 'it_department.html',
                    'HR': 'hr-dashboard.html',
                    'Finance': 'finance-dashboard.html',
                    'Admin': 'admin-dashboard.html'
                };

                const targetPage = rolePages[role];
                
                // Show success message
                this.showSuccess(`Xác thực thành công! Chuyển hướng đến ${role} dashboard...`);
                
                setTimeout(() => {
                    // In real implementation, redirect to actual pages
                    console.log(`Redirecting to: ${targetPage}`);
                    alert(`Chuyển hướng đến trang ${role}!\n\nTrong thực tế, bạn sẽ được chuyển đến: ${targetPage}`);
                    
                    // Reset form
                    this.resetForm();
                }, 2000);
            }

            // Utility functions
            hashString(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32bit integer
                }
                return Math.abs(hash).toString(16);
            }

            getRoleId(role) {
                const roleIds = { 'IT': 1, 'HR': 2, 'Finance': 3, 'Admin': 4 };
                return roleIds[role] || 0;
            }

            async updateZKPStep(step) {
                document.getElementById('zkpStep').textContent = step;
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            showError(message) {
                alert('❌ ' + message);
            }

            showSuccess(message) {
                const zkpStatus = document.getElementById('zkpStatus');
                zkpStatus.innerHTML = `
                    <div class="bg-green-500 bg-opacity-30 border border-green-400 rounded-lg p-3">
                        <div class="flex items-center text-white">
                            <i class="fas fa-check-circle text-green-400 mr-3 text-xl"></i>
                            <div class="font-medium">${message}</div>
                        </div>
                    </div>
                `;
            }

            resetForm() {
                document.getElementById('loginForm').reset();
                document.getElementById('zkpStatus').classList.add('hidden');
                document.getElementById('submitBtn').disabled = false;
                
                // Reset role selection styling
                document.querySelectorAll('.role-option div').forEach(div => {
                    div.classList.remove('bg-blue-500', 'bg-opacity-50', 'border-blue-400');
                    div.classList.add('bg-white', 'bg-opacity-20', 'border-white', 'border-opacity-30');
                });
            }
        }

        // Initialize the ZKP Authenticator when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new ZKPAuthenticator();
        });

        // Demo credentials for testing
        console.log('Demo credentials for testing:');
        console.log('Email: admin@company.com, Password: admin123, Role: Admin');
        console.log('Email: it@company.com, Password: it123, Role: IT');
        console.log('Email: hr@company.com, Password: hr123, Role: HR');
        console.log('Email: finance@company.com, Password: finance123, Role: Finance');
    </script>
</body>
</html>